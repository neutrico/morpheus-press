# Planning Pipeline - Automated Agent Workflow

**Cohesive pipeline for issue research, planning, estimation, and
visualization.**

## üéØ Overview

This pipeline automates the planning process using AI agents:

1. **üî® Build** - Combines modular YAML files
2. **üî¨ Research Agent** - Investigates technical approaches, dependencies,
   risks
3. **üìã Planning Agent** - Creates acceptance criteria, testing strategy,
   checklists
4. **üìä Effort Estimation** - Generates story point estimates based on
   research/planning
5. **üé® Visualization** - Updates charts, Gantt, schedules

**Key Innovation:** **Effort estimates are generated separately** (not hardcoded
in issues)

## üìÇ Structure

```
planning/
‚îú‚îÄ‚îÄ milestones.yaml              # User edits: milestone definitions
‚îú‚îÄ‚îÄ labels.yaml                  # User edits: labels, issue types
‚îú‚îÄ‚îÄ issues/                      # User edits: task definitions (NO effort field!)
‚îÇ   ‚îú‚îÄ‚îÄ m0-infrastructure.yaml
‚îÇ   ‚îú‚îÄ‚îÄ m1-backend.yaml
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ estimates/                   # Generated by agents
‚îÇ   ‚îú‚îÄ‚îÄ effort-map.yaml          # task_key -> effort/risk/confidence
‚îÇ   ‚îî‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ pi-metadata.yaml             # Config (capacity, iterations)
‚îú‚îÄ‚îÄ pi.yaml.built                # Generated: combined structure
‚îú‚îÄ‚îÄ pi-schedule.md               # Generated: schedule with dates
‚îî‚îÄ‚îÄ pi-visualization.ipynb       # Jupyter notebook for charts

scripts/planning/
‚îú‚îÄ‚îÄ 01-build-planning.py         # Combine modules
‚îú‚îÄ‚îÄ 02-research-agent.py         # Research tasks
‚îú‚îÄ‚îÄ 03-planning-agent.py         # Plan implementation
‚îú‚îÄ‚îÄ 04-estimate-effort.py        # Generate effort estimates
‚îú‚îÄ‚îÄ 05-update-visualization.py   # Update charts
‚îî‚îÄ‚îÄ run-pipeline.py              # Orchestrator
```

## üöÄ Quick Start

### 1. Run Complete Pipeline

```bash
# Production mode (calls Anthropic Claude API)
pnpm plan

# Dry run (preview without changes)
pnpm plan:dry-run
```

### 2. Run Individual Stages

```bash
# Build combined YAML
pnpm plan:build

# Research agent only
pnpm plan:research

# Planning agent only
pnpm plan:planning

# Effort estimation only
pnpm plan:estimate

# Update visualizations only
pnpm plan:viz
```

### 3. Advanced Usage

```bash
# Skip research (if already done)
python3 scripts/planning/run-pipeline.py --skip research

# Run only estimation
python3 scripts/planning/run-pipeline.py --only estimate

# Run specific stages
python3 scripts/planning/run-pipeline.py --stages build research estimate

# Dry run with verbose output
python3 scripts/planning/run-pipeline.py --dry-run --verbose
```

## üìù User Workflow

### Step 1: Edit Planning Files

**Edit issues (NO effort field needed!):**

```yaml
# planning/issues/m1-backend.yaml
issues:
  - key: T23
    title: Backend TypeScript Port
    type: Task
    milestone: M1 - Backend Services
    iteration: I2
    priority: p0
    area: backend
    dependsOn: [T3, T4]

    # NO effort field - generated by agents!

    description: |
      Port backend API to TypeScript from Python.

      **Context:** Current Python backend is difficult to maintain...
```

**Edit milestones/labels:**

```yaml
# planning/milestones.yaml
milestones:
  - name: M1 - Backend Services
    description: Core backend functionality
    dueDate: "2026-03-15"

# planning/labels.yaml
labels:
  area:
    - backend
    - frontend
    - ml
```

### Step 2: Run Pipeline

```bash
pnpm plan
```

**What happens:**

1. **Build** combines all YAML modules into `pi.yaml.built`
2. **Research Agent** (Claude 3.5 Haiku):
   - Reads task title + description
   - Researches technical approach
   - Identifies dependencies (npm packages, APIs)
   - Documents risks and mitigation strategies
   - Updates `agent_notes.research_findings`

3. **Planning Agent** (Claude 3.5 Haiku):
   - Creates 3-5 acceptance criteria (testable)
   - Defines testing strategy (unit, integration, e2e)
   - Lists files to modify/create
   - Generates 5-10 item implementation checklist
   - Estimates time (dev, review, testing, docs in days)

4. **Effort Estimation** (Claude 3.5 Haiku):
   - Analyzes checklist size, time estimates, complexity
   - Considers dependencies and risks
   - Generates story points (1, 2, 3, 5, 8, 13)
   - Outputs to `planning/estimates/effort-map.yaml`
   - **Confidence** (low/medium/high) and **Risk** (low/medium/high)

5. **Visualization**:
   - Executes Jupyter notebook
   - Generates interactive Gantt chart (HTML)
   - Updates schedule markdown
   - Shows capacity analysis per iteration

### Step 3: Review Results

**Generated effort estimates:**

```yaml
# planning/estimates/effort-map.yaml
generated_at: "2026-02-07T18:30:00Z"
version: "1.0.0"

estimates:
  T23:
    title: Backend TypeScript Port
    milestone: M1 - Backend Services
    iteration: I2
    effort: 8 # Story points
    confidence: medium
    risk: high
    estimated_days: 7
    reasoning: |
      Large refactor with 15 checklist items.
      Research revealed database schema changes needed.
      High risk due to production migration.

      Factors:
      - Complex acceptance criteria (performance + GDPR)
      - Multiple external dependencies
      - 7 day time estimate aligns with 8 pts

    adjusted_from: null # Was not previously estimated
    adjusted_by: effort-estimation-agent
    adjusted_at: "2026-02-07T18:25:00Z"
```

**Generated schedule:**

```markdown
# PI-2026-Q1 - Schedule

## I1

**Dates:** 2026-02-10 - 2026-02-23 **Effort:** 28 / 30 points (93%)

### M0 - Infrastructure

- **T1** Tech Stack Documentation (2 pts)
- **T2** GitHub Setup (2 pts)
```

**Interactive Gantt chart:**

Open `planning/pi-gantt-interactive.html` in browser.

## ü§ñ Agent Details

### Research Agent (02-research-agent.py)

**LLM:** Claude 3.5 Haiku (cost-effective, fast)

**Input:**

- Task key, title, type, milestone, area
- Current description (if any)

**Output:**

```yaml
agent_notes:
  research_findings: |
    **Context:** Why this exists...
    **Technical Approach:** Best practices...
    **Dependencies:** External + internal...
    **Risks:** What could go wrong...
    **Complexity:** More/less than expected?

  design_decisions:
    - decision: "Use Fastify over Express"
      rationale: "Better TypeScript support"
      alternatives_considered: ["Express", "Koa"]

  researched_at: "2026-02-07T18:00:00Z"
  researched_by: "research-agent-claude-3.5-haiku"

technical_notes:
  approach: |
    High-level implementation approach...

  external_dependencies:
    - name: "@fastify/cors"
      version: "^8.0.0"
      reason: "CORS handling"
```

**Usage:**

```bash
# All issues
pnpm plan:research

# Specific file
python3 scripts/planning/02-research-agent.py --file m1-backend.yaml

# Specific issue
python3 scripts/planning/02-research-agent.py --issue T23

# Dry run
python3 scripts/planning/02-research-agent.py --dry-run
```

### Planning Agent (03-planning-agent.py)

**LLM:** Claude 3.5 Haiku

**Prerequisites:** Issue must have research findings

**Output:**

```yaml
acceptance_criteria:
  - criterion: "Backend starts without errors"
    verification: "Run `pnpm dev:backend`, check logs"
  - criterion: "All routes respond"
    verification: "Health check returns 200"

testing:
  unit_tests:
    - file: "apps/backend/src/__tests__/server.test.ts"
      coverage_target: 85%
      scenarios: ["Happy path", "Error handling"]

  manual_testing:
    - step: "Start backend"
      expected: "Server listens on port 3002"

technical_notes:
  files_to_modify:
    - path: "apps/backend/src/server.ts"
      changes: "Convert to TypeScript, use Fastify"

  new_files:
    - path: "apps/backend/src/types/fastify.d.ts"
      purpose: "Type augmentations"

progress:
  checklist:
    - task: "Setup TypeScript config"
      done: false
    - task: "Convert routes to TypeScript"
      done: false
    - task: "Write unit tests"
      done: false

estimates:
  development: 5 # days
  code_review: 1
  testing: 0.5
  documentation: 0.5
  total: 7

agent_notes:
  planned_at: "2026-02-07T18:10:00Z"
  planned_by: "planning-agent-claude-3.5-haiku"
```

**Usage:**

```bash
# All issues (researched only)
pnpm plan:planning

# Specific file
python3 scripts/planning/03-planning-agent.py --file m1-backend.yaml

# Specific issue
python3 scripts/planning/03-planning-agent.py --issue T23
```

### Effort Estimation Agent (04-estimate-effort.py)

**LLM:** Claude 3.5 Haiku (or heuristic fallback)

**Prerequisites:** Issue has research + planning data

**Algorithm:**

1. Analyze checklist size (more items ‚Üí more effort)
2. Check time estimates (days ‚Üí points mapping)
3. Evaluate acceptance criteria complexity
4. Consider dependency count
5. Review risk from research findings
6. Generate story points (Fibonacci: 1, 2, 3, 5, 8, 13)

**Mapping (approximate):**

```
1 pt  = 0.5d, <3 items, trivial
2 pts = 1d, 3-5 items, simple
3 pts = 1-2d, 5-7 items, standard
5 pts = 3-4d, 8-10 items, complex
8 pts = 5-7d, 10-15 items, very complex
13 pts = 1-2 weeks, epic (should split)
```

**Output (effort-map.yaml):**

```yaml
estimates:
  T23:
    effort: 8
    confidence: medium # low | medium | high
    risk: high # low | medium | high
    estimated_days: 7
    reasoning: |
      15 checklist items ‚Üí 8 pts range
      7 day estimate aligns with very complex
      High risk factors from research
    adjusted_from: null
```

**Usage:**

```bash
# All planned issues
pnpm plan:estimate

# With heuristic (no LLM)
python3 scripts/planning/04-estimate-effort.py --use-heuristic

# Dry run
python3 scripts/planning/04-estimate-effort.py --dry-run
```

## üìä Effort Estimation Methodology

### Story Points (Not Hours!)

**Story points are relative complexity:**

- Complexity (technical difficulty)
- Effort (amount of work)
- Risk (unknowns, dependencies)
- Dependencies (integration points)

**NOT:**

- ‚ùå Hours of work
- ‚ùå Calendar days
- ‚ùå Lines of code

### Modified Fibonacci Scale

```
1 pt:  Trivial config change, doc update
2 pts: Simple feature, 1 day
3 pts: Standard task, 1-2 days (most common)
5 pts: Complex feature, requires research/integration
8 pts: Very complex, high risk, week-long effort
13 pts: Epic, should be split into smaller tasks
```

### Confidence Levels

```
high:   Well-understood, clear requirements, low risk
medium: Some unknowns, standard complexity
low:    Many unknowns, unclear requirements, needs spike
```

### Risk Levels

```
low:    Straightforward implementation, mature tech
medium: Some integration challenges, standard risk
high:   Performance concerns, security, new tech, migrations
```

## üîÑ Re-estimation Workflow

See [EFFORT_REESTIMATION_WORKFLOW.md](./EFFORT_REESTIMATION_WORKFLOW.md) for
details.

**When to re-estimate:**

- After research reveals hidden complexity
- After planning shows more work than expected
- When acceptance criteria become more demanding

**Process:**

1. Research agent may adjust initial rough estimate (¬±1-2 pts)
2. Planning agent validates against time/checklist (¬±1-3 pts)
3. Effort estimation agent generates final validated estimate

**Tracking adjustments:**

```yaml
estimates:
  T23:
    effort: 8
    adjusted_from: 5 # Initial rough estimate
    adjustment_reason: |
      Research revealed database migration needed (+2 pts)
      Planning found 15 checklist items vs 7 expected (+1 pt)
```

## üìà Capacity Management

**Configuration (pi-metadata.yaml):**

```yaml
safe:
  pi:
    capacity:
      pointsPerIteration: 30 # Team capacity per 2-week sprint
```

**Baseline Measurement:**

After first iteration (I1), measure **actual velocity**:

```
Planned: 30 pts
Completed: 25 pts
‚Üí Adjust capacity to 25 pts/iteration for remaining plan
```

**Rebalancing Strategies:**

If over capacity (e.g., 159% utilization):

1. **Extend timeline:** Add iterations
2. **Reduce scope:** Defer p2/p3 tasks
3. **Increase capacity:** Add team members
4. **Optimize estimates:** Re-evaluate high-effort tasks

## üõ†Ô∏è Development

### Adding New Agents

1. Create `scripts/planning/0X-agent-name.py`
2. Follow template structure (load YAML, process, save)
3. Add to `STAGES` dict in `run-pipeline.py`
4. Add npm script to `package.json`

### Customizing LLM Provider

**Currently: Anthropic Claude 3.5 Haiku**

**To use OpenAI instead:**

Edit agent scripts, replace:

```python
import anthropic
client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

response = client.messages.create(
    model="claude-3-5-haiku-20241022",
    max_tokens=2000,
    messages=[{"role": "user", "content": prompt}]
)
```

With:

```python
import openai
client = openai.OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

response = client.chat.completions.create(
    model="gpt-4o-mini",
    max_tokens=2000,
    messages=[{"role": "user", "content": prompt}]
)
```

### Testing Pipeline

```bash
# Dry run (no API calls, no file changes)
pnpm plan:dry-run

# Run on single issue
python3 scripts/planning/02-research-agent.py --issue T1 --dry-run
python3 scripts/planning/03-planning-agent.py --issue T1 --dry-run
python3 scripts/planning/04-estimate-effort.py --dry-run

# Check generated estimates
cat planning/estimates/effort-map.yaml
```

## üìã Troubleshooting

### Issue: "ANTHROPIC_API_KEY not set"

**Solution:**

```bash
# Add to .env or export
export ANTHROPIC_API_KEY=sk-ant-...

# Or use heuristic mode (no LLM)
python3 scripts/planning/04-estimate-effort.py --use-heuristic
```

### Issue: "Estimates file not found"

**Solution:**

```bash
# Run estimation first
pnpm plan:estimate

# Then visualization
pnpm plan:viz
```

### Issue: "Notebook execution failed"

**Solution:**

```bash
# Install Jupyter dependencies
pip install jupyter nbconvert plotly pandas networkx

# Execute manually
jupyter nbconvert --to notebook --execute --inplace planning/pi-visualization.ipynb
```

### Issue: "No issues were researched/planned"

**Reason:** Issues already have research/planning data

**Solution:**

```bash
# Check what needs work
python3 scripts/planning/02-research-agent.py --dry-run

# Force re-research specific issue
# (Delete agent_notes section in YAML first)
python3 scripts/planning/02-research-agent.py --issue T23
```

## üîó Related Documentation

- [AGENT_WORKFLOWS.md](./AGENT_WORKFLOWS.md) - Manual agent workflow guide
- [EFFORT_REESTIMATION_WORKFLOW.md](./EFFORT_REESTIMATION_WORKFLOW.md) -
  Re-estimation methodology
- [ISSUE_TEMPLATE.yaml](./ISSUE_TEMPLATE.yaml) - Complete issue structure
  reference
- [YAML_MARKDOWN_CONVERTERS.md](./YAML_MARKDOWN_CONVERTERS.md) - YAML ‚Üî Markdown
  conversion

## üéØ Next Steps

1. **Run first planning cycle:**
   ```bash
   pnpm plan:dry-run  # Preview
   pnpm plan          # Execute
   ```

2. **Review generated estimates:**
   ```bash
   cat planning/estimates/effort-map.yaml
   open planning/pi-gantt-interactive.html
   cat planning/pi-schedule.md
   ```

3. **Adjust capacity if needed:**
   - Edit `planning/pi-metadata.yaml`
   - Change `pointsPerIteration: 30` to measured velocity

4. **Begin development:**
   - Use GitHub sync: `python3 scripts/sync-to-github.py`
   - Track actual time per task
   - Re-calibrate estimates after I1

---

**Questions? Issues?**

Open GitHub issue or check [planning/README.md](./README.md) for more details.
