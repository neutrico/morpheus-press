name: Copilot Task Automation

# Trigger: When issue is assigned to Copilot or comment contains /automate
on:
  issues:
    types: [assigned, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-generate:
    runs-on: ubuntu-latest
    
    # Run only if:
    # 1. Issue assigned to copilot OR
    # 2. Comment contains /automate OR
    # 3. Label "automation:ready" added
    if: |
      (github.event_name == 'issues' && github.event.action == 'assigned' && contains(github.event.assignee.login, 'copilot')) ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'automation:ready') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/automate'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          pip install anthropic pyyaml python-dotenv
          npm install -g pnpm
          pnpm install
      
      - name: Extract task key from issue
        id: extract_task
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # Extract task key (e.g., T24, T25) from title or body
          TASK_KEY=$(echo "$ISSUE_TITLE $ISSUE_BODY" | grep -oP '[T]\d+' | head -1)
          
          if [ -z "$TASK_KEY" ]; then
            echo "âŒ No task key found in issue"
            exit 1
          fi
          
          echo "task_key=$TASK_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Found task key: $TASK_KEY"
      
      - name: Check if task is automatable
        id: check_automatable
        run: |
          TASK_KEY="${{ steps.extract_task.outputs.task_key }}"
          
          # Check if task has HIGH AI effectiveness
          python3 << EOF
          import yaml
          import sys
          
          with open('planning/estimates/effort-map.yaml', 'r') as f:
              effort_map = yaml.safe_load(f)
          
          task_key = "$TASK_KEY"
          
          if task_key not in effort_map['estimates']:
              print(f"âŒ Task {task_key} not found in effort-map.yaml")
              sys.exit(1)
          
          reasoning = effort_map['estimates'][task_key].get('reasoning', '')
          
          if 'AI Impact: HIGH' in reasoning:
              print(f"âœ… Task {task_key} is HIGH AI effectiveness - automatable!")
              sys.exit(0)
          else:
              print(f"âš ï¸  Task {task_key} is not HIGH AI effectiveness")
              print(f"    Automation may be less effective, but proceeding...")
              sys.exit(0)
          EOF
      
      - name: Run automation generator
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          TASK_KEY="${{ steps.extract_task.outputs.task_key }}"
          
          echo "ðŸ¤– Running automation for $TASK_KEY..."
          
          # Run task automation agent
          python3 scripts/automation/task-automation-agent.py "$TASK_KEY" 2>&1 | tee automation-log.txt
          
          # Check if files were generated
          if git diff --quiet; then
            echo "âš ï¸  No files generated"
            echo "generated=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Files generated successfully"
            echo "generated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create branch and commit
        id: commit
        if: steps.generate.outputs.generated == 'true'
        run: |
          TASK_KEY="${{ steps.extract_task.outputs.task_key }}"
          BRANCH_NAME="automation/$TASK_KEY-$(date +%Y%m%d-%H%M%S)"
          
          # Create branch
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git checkout -b "$BRANCH_NAME"
          
          # Stage all changes
          git add .
          
          # Commit
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          git commit -m "feat: $TASK_KEY - Auto-generated by automation" \
            -m "Generated by task-automation-agent.py" \
            -m "Issue: #$ISSUE_NUMBER" \
            -m "" \
            -m "âš ï¸  REQUIRES REVIEW:" \
            -m "- Check TODO comments" \
            -m "- Verify business logic" \
            -m "- Run tests: pnpm test" \
            -m "- Manual adjustments may be needed"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.generate.outputs.generated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK_KEY="${{ steps.extract_task.outputs.task_key }}"
          BRANCH_NAME="${{ steps.commit.outputs.branch }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Get task title from effort-map (or use default)
          TASK_TITLE=$(python3 -c "
          import yaml
          try:
              with open('planning/estimates/effort-map.yaml', 'r') as f:
                  effort_map = yaml.safe_load(f)
              print(effort_map.get('estimates', {}).get('$TASK_KEY', {}).get('title', 'Auto-generated task'))
          except:
              print('Auto-generated task')
          " 2>/dev/null || echo "Auto-generated task")
          
          # Read automation log
          AUTOMATION_LOG=$(cat automation-log.txt 2>/dev/null | tail -30 || echo "No log available")
          
          # Create PR body in a temporary file
          cat > /tmp/pr-body.md << 'EOF_MARKER'
## ðŸ¤– Auto-Generated Implementation

**Task:** ${TASK_KEY}
**Issue:** Closes #${ISSUE_NUMBER}
**Generated by:** task-automation-agent.py

---

### ðŸ“¦ What was generated:

Check the files changed in this PR.

### âš ï¸ IMPORTANT - Review Required:

This is **auto-generated code** that needs review:

- [ ] Check TODO comments in generated files
- [ ] Verify business logic correctness
- [ ] Run tests: `pnpm test`
- [ ] Check for placeholder code
- [ ] Verify database migrations (if any)
- [ ] Test API endpoints (if any)
- [ ] Update documentation if needed

### ðŸ“ Next Steps:

1. **Copilot Agent**: Review and fix TODO comments
2. **Human Developer**: Test manually
3. **CI/CD**: Verify tests pass
4. **Merge**: After approval

---

**Generated at:** $(date -Iseconds)
EOF_MARKER
          
          # Substitute variables in PR body
          sed -i "s/\${TASK_KEY}/$TASK_KEY/g" /tmp/pr-body.md
          sed -i "s/\${ISSUE_NUMBER}/$ISSUE_NUMBER/g" /tmp/pr-body.md
          
          # Create PR
          gh pr create \
            --title "feat: $TASK_KEY - Auto-generated implementation [AUTO-GENERATED]" \
            --body-file /tmp/pr-body.md \
            --assignee copilot \
            --label "auto-generated,needs-review" \
            --base main \
            --head "$BRANCH_NAME"
          
          echo "âœ… PR created and assigned to @copilot"
      
      - name: Comment on issue
        if: steps.generate.outputs.generated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK_KEY="${{ steps.extract_task.outputs.task_key }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ¤– **Auto-generated code is ready!**

I've generated starter code for **$TASK_KEY** and created a PR.

**What was generated:**
- Boilerplate code based on task specifications
- Tests scaffolding
- TODO comments for manual implementation

**Next steps:**
1. Review the PR (link above)
2. @copilot will refine the implementation
3. Human review required before merge

**Note:** This is starter code - not production-ready yet! âš ï¸
"
      
      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          TASK_KEY="${{ steps.extract_task.outputs.task_key }}"
          
          gh issue comment "$ISSUE_NUMBER" --body "âŒ **Automation failed for $TASK_KEY**

The automation script encountered an error. Possible reasons:

1. Task pattern not recognized
2. Missing task documentation in \`planning/docs/\`
3. API rate limit exceeded
4. Invalid task specification

**Fallback:** Please implement manually or check automation logs.

**Debug:** Check [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
"
